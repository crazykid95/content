category: IT Services
commonfields:
  id: Cherwell
  version: -1
configuration:
- display: url
  name: url
  required: true
  type: 0
- display: Username
  name: credentials
  required: true
  type: 9
- display: Client ID
  name: client_id
  required: true
  type: 0
- defaultvalue: 'true'
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy
  name: proxy
  required: false
  type: 8
- defaultvalue: 3 days
  display: First fetch timestamp (<number> <time unit>, e.g., 12 hours, 7 days)
  name: fetch_time
  required: false
  type: 0
description: Integration Template
detaileddescription: Use these detailed instructions in order to retrieve the API
  key
display: Cherwell
name: Cherwell
script:
  commands:
  - arguments:
    - default: false
      description: '-'
      isArray: false
      name: description
      required: true
      secret: false
    - auto: PREDEFINED
      default: false
      description: '-'
      isArray: false
      name: priority
      predefined:
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: subcategory
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by_team
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: customer_display_name
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: source
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: service
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: category
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: form_view
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: short_description
      required: true
      secret: false
    description: Get items from service.
    execution: false
    name: cherwell-create-incident
    outputs:
    - contextPath: Example.Item.ID
      description: Item ID
      type: number
    - contextPath: Example.Item.Name
      description: Item name
      type: string
    - contextPath: Example.Item.CreatedDate
      description: Item creation date
      type: date
  - arguments:
    - auto: PREDEFINED
      default: false
      description: '-'
      isArray: false
      name: priority
      predefined:
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: description
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: service
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: category
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: subcategory
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: customer_display_name
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by_team
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: source
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: form_view
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: short_description
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: status
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: incident_public_id
      required: true
      secret: false
    description: Update a given incident
    execution: false
    name: cherwell-update-incident
  - description: List all incidents
    execution: false
    name: cherwell-list-incidents
  - arguments:
    - default: false
      description: The incident recored or public ID
      isArray: false
      name: incident_id
      required: true
      secret: false
    - auto: PREDEFINED
      default: false
      description: Type of ID
      isArray: false
      name: id_type
      predefined:
      - record_id
      - public_id
      required: true
      secret: false
    description: Update a given incident
    execution: false
    name: cherwell-get-incident
  - arguments:
    - default: false
      description: Task's title.
      isArray: false
      name: title
      required: true
      secret: false
    - default: false
      description: Description for the task.
      isArray: false
      name: description
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by_team
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: type
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: vendor_record
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: incident_record_id
      required: true
      secret: false
    description: Creates a task
    execution: false
    name: cherwell-create-task
  - arguments:
    - default: false
      description: Tasks' title
      isArray: false
      name: title
      required: false
      secret: false
    - default: false
      description: The description of the task
      isArray: false
      name: description
      required: false
      secret: false
    - default: false
      description: ID of the task.
      isArray: false
      name: task_public_id
      required: true
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: status
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: owned_by_team
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: type
      required: false
      secret: false
    - default: false
      description: '-'
      isArray: false
      name: vendor_record
      required: false
      secret: false
    description: Updates the task
    execution: false
    name: cherwell-update-task
  - arguments:
    - default: false
      description: Name of the business object
      isArray: false
      name: business_obj_name
      required: false
      secret: false
    - default: false
      description: ID of the business ID (will override name if provided)
      isArray: false
      name: business_obj_id
      required: false
      secret: false
    - default: false
      description: Text to look for in the business object.
      isArray: false
      name: search_text
      required: true
      secret: false
    description: Searches for a text in a business object.
    execution: false
    name: cherwell-search-in-business-object
  - arguments:
    - auto: PREDEFINED
      default: false
      defaultValue: Type of ID
      description: '-'
      isArray: false
      name: id_type
      predefined:
      - record_id
      - public_id
      required: true
      secret: false
    - default: false
      description: Public or record ID of the task
      isArray: false
      name: task_id
      required: true
      secret: false
    description: Search free text onsode a businsess object list
    execution: false
    name: cherwell-get-task
  isfetch: false
  runonce: false
  script: |-
    ''' IMPORTS '''

    import json
    import requests
    from distutils.util import strtobool

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    USERNAME = demisto.params().get('credentials').get('identifier')
    PASSWORD = demisto.params().get('credentials').get('password')
    SERVER = demisto.params()['url'][:-1] if (demisto.params()['url'] and demisto.params()['url'].endswith('/')) else demisto.params()['url']  # Remove trailing slash to prevent wrong URL path to service
    CLIENT_ID = demisto.params().get('client_id')
    # Service base URL
    BASE_URL = SERVER + '/CherwellAPI/'

    BUSINESS_OBJECT_IDS = {
        "incident": "6dd53665c0c24cab86870a21cf6434ae",
        "task": "9355d5ed41e384ff345b014b6cb1c6e748594aea5b",
    }

    INCIDENT_FIELD_DICT = {
        "service": {
            "displayName": "Service",
            "name": "Service",
            "field_id": "936725cd10c735d1dd8c5b4cd4969cb0bd833655f4"
        },
        "category": {
            "displayName": "Category",
            "name": "Category",
            "field_id": "9e0b434034e94781ab29598150f388aa"
        },
        "subcategory": {
            "displayName": "Subcategory",
            "name": "Subcategory",
            "field_id": "1163fda7e6a44f40bb94d2b47cc58f46"
        },
        "description": {
            "displayName": "Description",
            "name": "Description",
            "field_id": "252b836fc72c4149915053ca1131d138"
        },
        "priority": {
            "displayName": "Priority",
            "name": "Priority",
            "field_id": "83c36313e97b4e6b9028aff3b401b71c"
        },
        "customer_display_name": {
            "displayName": "Customer Display Name",
            "name": "CustomerDisplayName",
            "field_id": "93734aaff77b19d1fcfd1d4b4aba1b0af895f25788"
        },
        "owned_by": {
            "displayName": "Owned By",
            "name": "OwnedBy",
            "field_id": "9339fc404e4c93350bf5be446fb13d693b0bb7f219"
        },
        "owned_by_team": {
            "displayName": "Owned By Team",
            "name": "OwnedByTeam",
            "field_id": "9339fc404e8d5299b7a7c64de79ab81a1c1ff4306c"
        },
        'source': {
            "displayName": "Source",
            "field_id": "93670bdf8abe2cd1f92b1f490a90c7b7d684222e13",
            "name": "Source"
        },
        'form_view': {
            "displayName": "Form View",
            "field_id": "9416983037b2b2cded624d4168964b5f0fce05d285",
            "name": "FormView"
        },
        'short_description': {
            "displayName": "Short Description",
            "field_id": "93e8ea93ff67fd95118255419690a50ef2d56f910c",
            "name": "ShortDescription"
        },
        'status': {
            "displayName": "Status",
            "field_id": "5eb3234ae1344c64a19819eda437f18d",
            "name": "Status"
        },
        'restaurant_number': {
            "displayName": "Restaurant Number",
            "field_id": "9413aa138a4d8ec546418249499b66c9aa948eb522",
            "name": "RestaurantNumber"
        }
    }

    INCIDENT_HEADERS_NAMES = [
        "IncidentPublicID",
        "IncidentRecordID",
        "Status",
        "CustomerDisplayName",
        "Description",
        "OwnedBy",
        "OwnedByTeam",
        "TotalTasks",
        "CreatedDateTime",
        "SLAResolveByDeadline"
    ]

    TASK_HEADERS_NAMES = [
        "TaskPublicID",
        "TaskRecordID",
        "ParentPublicID",
        "ParentTypeName",
        "Status",
        "CustomerDisplayName",
        "Description",
        "OwnedBy",
        "OwnedByTeam",
        "TotalTasks",
        "CreatedDateTime",
        "SLAResolveByDeadline",
        "VendorRecord"
    ]
    # disable-secrets-detection-start
    HEADERS_IDS = {
        'incident': [
            "6ae282c55e8e4266ae66ffc070c17fa3",  # Incident ID
            "936725cd10c735d1dd8c5b4cd4969cb0bd833655f4",  # Service
            "9e0b434034e94781ab29598150f388aa",  # Category
            "1163fda7e6a44f40bb94d2b47cc58f46",  # Subcategory
            "252b836fc72c4149915053ca1131d138",  # Description[
            "83c36313e97b4e6b9028aff3b401b71c",  # Priority
            "93734aaff77b19d1fcfd1d4b4aba1b0af895f25788",  # Customer Display Name
            "9339fc404e4c93350bf5be446fb13d693b0bb7f219",  # OwnedBy
            "9339fc404e8d5299b7a7c64de79ab81a1c1ff4306c",  # Owned By Team
            "93670bdf8abe2cd1f92b1f490a90c7b7d684222e13",  # Source
            "9416983037b2b2cded624d4168964b5f0fce05d285",  # FormView
            "93e8ea93ff67fd95118255419690a50ef2d56f910c",  # Short Description
            "c1e86f31eb2c4c5f8e8615a5189e9b19",  # Created Date Time
            "5eb3234ae1344c64a19819eda437f18d"  # Status
        ],
        'task': [
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:93ad98a2d68a61778eda3d4d9cbb30acbfd458aea4",   # Title
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:93cfd5a4e13f7d4a4de1914f638abebee3a982bb50",   # Owned
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:9368f0fb7b744108a666984c21afc932562eb7dc16",   # Status
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:9355d5ef648edf7a8ed5604d56af11170cce5dc25e",   # Description
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:93cfd5a4e10af4933a573444d08cbc412da491b42e",   # Owned
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:9355d5ed6ca15a8308c5e24389b2138b3aa9b6c7fa",   # Type
            "BO:9355d5ed41e384ff345b014b6cb1c6e748594aea5b,FI:942c29e6afe42dcbceaf024539b61a843e6d9d3599"    # Vendor
        ]
    }

    # disable-secrets-detection-end

    TASK_FIELD_DICT = {
        'title': {
            "displayName": "Title",
            "field_id": "93ad98a2d68a61778eda3d4d9cbb30acbfd458aea4",
            "name": "Title"
        },
        'owned_by': {
            "displayName": "Owned By",
            "field_id": "93cfd5a4e13f7d4a4de1914f638abebee3a982bb50",
            "name": "OwnedBy"
        },
        'status': {
            "displayName": "Status",
            "field_id": "9368f0fb7b744108a666984c21afc932562eb7dc16",
            "name": "Status"
        },
        "description": {
            "displayName": "Description",
            "name": "Description",
            "field_id": "9355d5ef648edf7a8ed5604d56af11170cce5dc25e"
        },
        'owned_by_team': {
            "displayName": "Owned By Team",
            "field_id": "93cfd5a4e10af4933a573444d08cbc412da491b42e",
            "name": "OwnedByTeam"
        },
        'type': {
            "field_id": "9355d5ed6ca15a8308c5e24389b2138b3aa9b6c7fa",
            "name": "Type",
            "displayName": "Type"
        },
        'vendor_record': {
            "field_id": "942c29e6afe42dcbceaf024539b61a843e6d9d3599",
            "name": "VendorRecord",
            "displayName": "Vendor Record"
        }
    }

    RELATIONSHIP_IDS = {
        "incident_owns_task": "9369187528b417b4a17aaa4646b7f7a78b3c821be9"
    }


    ############################################################################################################################################################################################################

    def parse_response(response, error_operation):
        try:
            response.raise_for_status()
            if not response.content:
                return
            return response.json()
        except requests.exceptions.HTTPError:
            err_msg = response.json().get('errorMessage') or response.json().get('error_description') or response.json().get('Message')
            return_error(error_operation + ": " + err_msg)
        except Exception, error:
            return_error("Could not parse response ".format(error))


    def parse_fields_from_business_object(Field_list):
        new_business_obj = {}
        for field in Field_list:
            field_name = field.get('name')
            new_business_obj[field_name] = field.get('value')

        return new_business_obj


    def parse_fields_from_response(response):
        object_list = []
        for business_obj in response.get('businessObjects'):
            new_business_obj = parse_fields_from_business_object(business_obj.get('fields'))
            object_list.append(new_business_obj)

        return object_list


    def build_fields_for_incident(args):
        fields = []
        for arg_key, arg_value in args.iteritems():
            new_field = {
                "dirty": "true",
                # "displayName": demisto.get(INCIDENT_FIELD_DICT, "{}.displayName".format(arg_key)),
                "fieldId": demisto.get(INCIDENT_FIELD_DICT, "{}.field_id".format(arg_key)),
                "name": demisto.get(INCIDENT_FIELD_DICT, "{}.name".format(arg_key)),
                "value": arg_value
            }
            fields.append(new_field)
        return fields


    def build_fields_for_task(args):
        fields = []
        for arg_key, arg_value in args.iteritems():
            new_field = {
                "dirty": "true",
                "displayName": demisto.get(TASK_FIELD_DICT, "{}.displayName".format(arg_key)),
                "fieldId": demisto.get(TASK_FIELD_DICT, "{}.field_id".format(arg_key)),
                "name": demisto.get(TASK_FIELD_DICT, "{}.name".format(arg_key)),
                "value": arg_value
            }
            fields.append(new_field)
        return fields


    def get_token():
        url = BASE_URL + "token"

        payload = "grant_type=password&client_id={0}&username={1}&password={2}".format(CLIENT_ID, USERNAME, PASSWORD)
        headers = {
            'Accept': "application/json",
            'Content-Type': "application/x-www-form-urlencoded",
        }

        response = requests.request("POST", url, data=payload, headers=headers)
        res_json = parse_response(response, "Could not get token")
        return res_json.get('access_token')


    def save_business_object(payload):
        url = BASE_URL + "api/V1/savebusinessobject"

        headers = {
            'Content-Type': "application/json",
            'Authorization': "Bearer {}".format(TOKEN)
        }

        response = requests.request("POST", url, data=json.dumps(payload), headers=headers)
        res_json = parse_response(response, "Could not save business object")
        return res_json


    def get_business_object(busob_id, incident_id, id_type):
        id_type_str = 'publicid' if id_type == 'public_id' else 'busobrecid'
        url = BASE_URL + "api/V1/getbusinessobject/busobid/{0}/{1}/{2}".format(busob_id, id_type_str, incident_id)
        headers = {
            'Authorization': "Bearer {}".format(TOKEN)
        }
        response = requests.request("GET", url, headers=headers)
        res_json = parse_response(response, "Could not get incident")
        return res_json


    def get_search_results(payload):
        url = BASE_URL + "api/V1/getsearchresults"

        headers = {
            'Content-Type': "application/json",
            'Authorization': "Bearer {}".format(TOKEN)
        }

        response = requests.request("POST", url, data=json.dumps(payload), headers=headers)
        res_json = parse_response(response, "Could not get incidents")
        return res_json


    def create_incident():
        args = demisto.args()
        # args["createdDateTime"] = datetime.now().strftime("%m-%d-%y %H:%M:%S %p")
        payload = {
            "busObId": BUSINESS_OBJECT_IDS['incident'],
            "fields": build_fields_for_incident(args)
        }

        result = save_business_object(payload)
        ids = {
            'IncidentPublicID': result.get('busObPublicId'),
            'IncidentRecordID': result.get('busObRecId')
        }
        md = tableToMarkdown('New Incident was created', ids, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Incidents(val.IncidentPublicID == obj.IncidentPublicID)': ids
            }
        })


    def update_incident():
        args = demisto.args()
        incident_public_id = args.get('incident_public_id')
        args.pop('incident_public_id')

        incident_fields = build_fields_for_incident(args)

        payload = {
            "busObId": BUSINESS_OBJECT_IDS['incident'],
            "busObPublicId": incident_public_id,
            "fields": incident_fields
        }

        results = save_business_object(payload)
        md = "### Incident: {} was updated".format(incident_public_id)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md
        })


    def update_incident_status():
        args = demisto.args()
        incident_public_id = args.get('incident_public_id')
        status = args.get('status')
        args.pop('incident_public_id')

        payload = {
            "busObId": BUSINESS_OBJECT_IDS['incident'],
            "busObPublicId": incident_public_id,
            "fields": build_fields_for_incident(args)
        }

        results = save_business_object(payload)

        md = "### Incident: {0} new status is: {1}".format(incident_public_id, status)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Incidents(val.IncidentID == {0}).Status'.format(incident_public_id): status
            }
        })


    def list_incidents():
        payload = {
            "busObId": BUSINESS_OBJECT_IDS['incident'],
            "pageNumber": 0,
            "pageSize": 300,
            "fields": HEADERS_IDS['incident']
        }

        results = get_search_results(payload)
        incidents = parse_fields_from_response(results)
        md = tableToMarkdown('Incidents List', incidents, headers=INCIDENT_HEADERS_NAMES, removeNull=True, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Incidents': incidents
            }
        })


    def get_incident_command():
        args = demisto.args()
        incident_id = args.get('incident_id')
        id_type = args.get('id_type')
        results = get_business_object(BUSINESS_OBJECT_IDS["incident"], incident_id, id_type)
        incident = parse_fields_from_business_object(results.get('fields'))
        incident['IncidentPublicID'] = results.get('busObPublicId')
        incident['IncidentRecordID'] = results.get('busObRecId')
        md = tableToMarkdown('Incidents Number: {}'.format(incident_id), incident, headers=INCIDENT_HEADERS_NAMES, removeNull=True, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Incidents(val.IncidentPublicID == obj.IncidentPublicID)': createContext(incident, removeNull=True)
            }
        })


    def get_task_command():
        args = demisto.args()
        task_id = args.get('task_id')
        id_type = args.get('id_type')
        results = get_business_object(BUSINESS_OBJECT_IDS["task"], task_id, id_type)
        task = parse_fields_from_business_object(results.get('fields'))
        task['TaskPublicID'] = results.get('busObPublicId')
        task['TaskRecordID'] = results.get('busObRecId')
        md = tableToMarkdown('Task Number: {}'.format(task_id), task, headers=TASK_HEADERS_NAMES, removeNull=True, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Tasks(val.TaskPublicID == obj.TaskPublicID)': createContext(task, removeNull=True)
            }
        })


    # def get_business_object_command():
    #     demisto.results(get_business_object_summary())


    # def get_business_object_summary():
    #     args = demisto.args()
    #     name = args.get('name')
    #     url = BASE_URL + "api/V1/getbusinessobjectsummary/busobname/{}".format(name)
    #
    #     headers = {
    #         'Content-Type': "application/json",
    #         'Authorization': "Bearer {}".format(TOKEN)
    #     }
    #
    #     response = requests.request("GET", url, headers=headers)
    #     return response.json()

    def create_task():
        args = demisto.args()
        payload = {
            "busObId": BUSINESS_OBJECT_IDS['task'],
            "fields": build_fields_for_task(args)
        }

        # payload = {
        #     "fields": [
        #         {
        #             "displayName": "Status",
        #             "fieldId": "9368f0fb7b744108a666984c21afc932562eb7dc16",
        #             "dirty": "true",
        #             "name": "Status",
        #             "value": "New"
        #         },
        #         {
        #             "fieldId": "9355d5ef648edf7a8ed5604d56af11170cce5dc25e",
        #             "displayName": "Description",
        #             "dirty": "true",
        #             "value": "task description",
        #             "name": "Description"
        #         },
        #         {
        #             "fieldId": "93ad98a2d68a61778eda3d4d9cbb30acbfd458aea4",
        #             "displayName": "Title",
        #             "dirty": "true",
        #             "value": "task title",
        #             "name": "Title"
        #         },
        #         {
        #             "dirty": "true",
        #             "displayName": "Next Status Text",
        #             "fieldId": "93d380768b15aeedaf86064b079df33a4e1e60caaa",
        #             "name": "NextStatusText",
        #             "value": "Acknowledge"
        #         },
        #         {
        #             "dirty": "true",
        #             "displayName": "Task Type ID",
        #             "fieldId": "942df01b5fe45a39f6fdaa48d3a10ddd304fa2e6c8",
        #             "name": "TaskTypeID",
        #             "value": "942e71e8c5c493f3e5f2f54f5c9c086719b6bc8d83"
        #         },
        #         {
        #             "fieldId": "93d3807e794090fc3ec96c436ab72e111dcd3d94dd",
        #             "displayName": "Status ID",
        #             "dirty": "true",
        #             "value": "93ad9c0fd473c969351fd34dde9b56ae91705fa3e8",
        #             "name": "StatusID"
        #         }
        #     ],
        #     "busObId": "9355d5ed41e384ff345b014b6cb1c6e748594aea5b"
        # }

        response = save_business_object(payload)
        return response


    def link_related_business_objects(parent_business_object_id, parent_business_object_record_id, relationship_id, business_object_id, business_object_record_id):
        url = BASE_URL + "api/V1/linkrelatedbusinessobject/parentbusobid/{0}/parentbusobrecid/{1}/relationshipid/{2}/busobid/{3}/busobrecid/{4}".format(parent_business_object_id,
                                                                                                                                                        parent_business_object_record_id,
                                                                                                                                                        relationship_id,
                                                                                                                                                        business_object_id,
                                                                                                                                                        business_object_record_id)
        headers = {
            'Accept': "application/json",
            'Authorization': "Bearer {}".format(TOKEN)
        }

        response = requests.request("GET", url, headers=headers)
        parse_response(response, "Could not link business objects")
        return


    def create_task_command():
        args = demisto.args()
        parent_business_object_record_id = args.get('incident_record_id')
        args.pop('incident_record_id')
        result = create_task()
        link_related_business_objects(BUSINESS_OBJECT_IDS['incident'], parent_business_object_record_id, RELATIONSHIP_IDS['incident_owns_task'], BUSINESS_OBJECT_IDS['task'], result.get('busObRecId'))

        ids = {
            'TaskPublicID': result.get('busObPublicId'),
            'TaskRecordID': result.get('busObRecId'),
            'IncidentRecordID': parent_business_object_record_id
        }
        md = tableToMarkdown('New Task was created', ids, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Tasks(val.TaskPublicID == obj.TaskPublicID)': ids
            }
        })


    def update_task_command():
        demisto.results(update_task())


    def update_task():
        args = demisto.args()
        task_public_id = args.get('task_public_id')
        args.pop('task_public_id')

        task_fields = build_fields_for_task(args)

        payload = {
            "busObId": BUSINESS_OBJECT_IDS['task'],
            "busObPublicId": task_public_id,
            "fields": task_fields
        }

        results = save_business_object(payload)
        md = "### Task: {} was updated".format(task_public_id)
        return ({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md
        })


    def search_in_business_object_command():
        results = search_in_business_object()
        parsed_results = parse_fields_from_response(results)
        md = tableToMarkdown('Search Results', parsed_results, removeNull=True, headerTransform=pascalToSpace)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': results,
            'HumanReadable': md,
            'EntryContext': {
                'Cherwell.Search': createContext(parsed_results, removeNull=True)
            }
        })


    def search_in_business_object():
        args = demisto.args()
        business_obj_name = args.get('business_obj_name')
        business_obj_id = args.get('business_obj_id')
        if business_obj_name or business_obj_id:
            try:
                bus_id = business_obj_id if business_obj_id else BUSINESS_OBJECT_IDS[business_obj_name.lower()]
                bus_name = business_obj_name if business_obj_name else BUSINESS_OBJECT_IDS.keys()[BUSINESS_OBJECT_IDS.values().index(bus_id)]
                fields_list = HEADERS_IDS[bus_name]
                payload = {
                    "busObId": bus_id,
                    "pageNumber": 0,
                    "pageSize": 300,
                    "searchText": args.get('search_text'),
                    "fields": fields_list
                }
            except KeyError:
                return_error('Error: ID for {} not found'.format(args.get('business_obj_name')))
        else:
            return_error('Error: Please provide either a business object ID or Name')
        return get_search_results(payload)


    ################################################################################################################################################################################################################################################


    ''' COMMANDS MANAGER / SWITCH PANEL '''

    LOG('Command being called is %s' % (demisto.command()))

    try:
        TOKEN = get_token()
        if demisto.command() == 'test-module':
            demisto.results('ok')
        elif demisto.command() == 'cherwell-create-incident':
            create_incident()

        elif demisto.command() == 'cherwell-update-incident':
            update_incident()

        elif demisto.command() == 'cherwell-list-incidents':
            list_incidents()

        elif demisto.command() == 'cherwell-get-incident':
            get_incident_command()

        elif demisto.command() == 'cherwell-create-task':
            create_task_command()

        elif demisto.command() == 'cherwell-update-incident-status':
            update_incident_status()

        # elif demisto.command() == 'cherwell-get-business-object-summary':
        #     get_business_object_command()

        elif demisto.command() == 'cherwell-update-task':
            update_task_command()

        elif demisto.command() == 'cherwell-search-in-business-object':
            search_in_business_object_command()

        elif demisto.command() == 'cherwell-get-task':
            get_task_command()

    # Log exceptions
    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        return_error("Unexpected error: {}".format(e))
  type: python
image: data:image/png;base64,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
tests:
- No tests - For POC only later on tests will be added
